/*!
 * SMValidator 1.0.1
 * Copyright (c) 2016 WLDragon(cwloog@qq.com)
 * Released under the MIT License.
 */!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):e.SMValidator=r()}(this,function(){"use strict";function e(e){return"checkbox"===e||"radio"===e}function r(e){return"string"==typeof e}function s(e,r){return c.call(e,r)}function t(e,r){var t=this;r||(r={});for(var n=d.length-1;n>=0;n--){var l=d[n];t[l]=s(r,l)?r[l]:y[l]}if(t.fields={},t.rules=r.rules||{},e){t.submit=r.submit;for(var a in r.fields)t.fields[a]=t.parseField(r.fields[a]);t.queryInput(e)}}function n(e,r){if(e)for(var s=e.length-1;s>=0;s--){for(var t=e[s],n=t.target,l=t.className.split(" "),a=n.className.split(" "),i=l.length-1;i>=0;i--){var u=l[i],f=a.indexOf(u);!r&&f>-1?a.splice(f,1):r&&f===-1&&a.push(u)}n.className=a.join(" ")}}function l(e,r,s){if(e)for(var t=e.length-1;t>=0;t--){var n=e[t];n.dom.style.display=r?"":"none",s&&!n.quiet&&(n.dom.innerHTML=s)}}function a(e,r){if(r)for(var s in r)e.style[s]=r[s]}function i(e){var r=e._sm;a(e,r.style),l(r.failHtml,!1),l(r.passHtml,!1),n(r.failCss,!1),n(r.passCss,!1)}function u(r,s){var t=r.type,u=r.name,f=r._sm,o=f.rule,p=!0,c=[],d=1,v="",m="|"===o.token;if(e(t)&&r.form)for(var h=r.form.elements[u],y=h.length-1;y>=0;y--)h[y].checked&&(v+=" ");else if("select-multiple"===t)for(var h=r.children,y=h.length-1;y>=0;y--)h[y].selected&&h[y].value&&(v+=" ");else v=r.value;if(s&&"number"==typeof s.forceFlag)d=s.forceFlag,o.server&&(f.serverFlag=d,s.serverMessage&&(f.serverMessage=s.serverMessage),2===d&&(p=f.serverMessage||"no serverMessage!"));else if(o.server)o.required&&!v?(d=2,p=o.required):"number"==typeof f.serverFlag?(d=f.serverFlag,2===d&&(p=f.serverMessage||"no serverMessage!")):v?(d=2,p=o.server):d=0;else if(v)for(var y=o.rules.length-1;y>=0;y--){var b=o.rules[y],S=b.rule;if(S instanceof RegExp){if(!S.test(v)){if(p=b.message,d=2,m)break;c.push(p)}}else if(p=b.params?S.apply(null,[v].concat(b.params)):S.call(null,v),p!==!0){if(d=2,m)break;c.push(p)}}else o.required?(d=2,p=o.required,m||c.push(p)):d=0;return m||(d=c.length?2:1),i(r),1===d?(n(f.failCss,!1),n(f.passCss,!0),a(r,o.passStyle),l(f.passHtml,!0),o.pass&&o.pass.call(r)):2===d&&(n(f.passCss,!1),n(f.failCss,!0),a(r,o.failStyle),l(f.failHtml,!0,m?p:c.join("<br/>")),o.fail&&o.fail.call(r,m?p:c)),2===d&&g&&(r.scrollIntoView(),g=!1),p}var f=window.document,o=f.addEventListener?f.addEventListener:f.attachEvent,p="oninput"in f?"input":"propertychange";o.call(f,p,function(e){var r=e.target;!r._sm||r._sm.rule.disinput||r._sm.rule.manul||u(r)}),o.call(f,"change",function(r){var s=r.target;e(s.type)&&s._sm&&!s._sm.rule.manul&&u(s)});var c=Object.prototype.hasOwnProperty,d=["required","server","short","disinput","disblur","focus","manul","failHtml","failStyle","failCss","passHtml","passStyle","passCss"],v=d.slice(3),m=t.prototype;m.queryInput=function(e){for(var r=this,s=[],n=f.querySelectorAll(e),l=n.length-1;l>=0;l--){var a=n[l],i=a.tagName;if("FORM"===i){a.novalidate="novalidate";for(var u=[],p=a.length-1;p>=0;p--)r.bindInput(a[p])&&u.push(a[p]);s=s.concat(u),r.submit&&u.length&&(a._smInputs=u,o.call(a,"submit",function(e){e.preventDefault();var s=t.validate(e.target._smInputs,{locate:!0,short:r.short});r.submit(s,e.target)}))}else"INPUT"!==i&&"SELECT"!==i&&"TEXTAREA"!==i||r.bindInput(a)&&s.push(a)}return s},m.bindInput=function(r){if(r._sm)return!0;var t=this,n=r.getAttribute("name"),l=r.getAttribute("data-rule"),a=l?this.parseString(l):this.fields[n];if(a){if(r._sm={rule:a,flag:0},!a._isInit){a._isInit=!0,t.handleProperty(a,"required"),t.handleProperty(a,"server"),a.server&&(a.manul=!0);for(var p=v.length-1;p>=0;p--){var c=v[p];s(a,c)||(a[c]=this[c])}t.handleStyle(a,"failStyle"),t.handleStyle(a,"passStyle")}if(e(r.type)){for(var d=f.querySelectorAll('input[name="'+n+'"]'),p=d.length-1;p>=0;p--)d[p]!==r&&(d[p]._sm=r._sm);a.disblur=a.disinput=!0,a.focus=!1}return t.recordStyle(r,a.failStyle),t.recordStyle(r,a.passStyle),t.handleHtml(r,"failHtml",a.failHtml),t.handleHtml(r,"passHtml",a.passHtml),t.handleCss(r,"failCss",a.failCss),t.handleCss(r,"passCss",a.passCss),a.focus&&o.call(r,"focus",function(e){i(e.target)}),a.disblur||o.call(r,"blur",function(e){u(e.target)}),!0}return!1},m.handleProperty=function(e,r){s(e,r)?e[r]===!0&&(e[r]=this[r]):e[r]=!1},m.handleStyle=function(e,s){if(r(e[s]))try{e[s]=JSON.parse(e[s].replace(/'/g,'"'))}catch(r){console.error("error json format: "+e[s])}},m.recordStyle=function(e,r){if(r){e._sm.style||(e._sm.style={});var s=e._sm.style;for(var t in r)s[t]||(s[t]=e.style[t])}},m.handleHtml=function(e,s,t){if(t){e._sm[s]=[],r(t)&&(t=[t]);for(var n=0;n<t.length;n++){var l,a=t[n],i={};if(0===a.indexOf("!")&&(a=a.substring(1),i.quiet=!0),a.indexOf("<")>-1){for(var u=e;0===a.indexOf("+");)a=a.substring(1),u=u.parentNode;var o=f.createElement("div");o.innerHTML=a,l=o.children[0],u.parentNode.insertBefore(l,u.nextElementSibling)}else l=f.querySelector(a);l&&(i.dom=l,l.style.display="none",e._sm[s].push(i))}}},m.handleCss=function(e,s,t){if(t){r(t)&&(t=[t]),e._sm[s]=[];for(var n=t.length-1;n>=0;n--){for(var l=t[n],a=e;0===l.indexOf("+");)l=l.substring(1),a=a.parentNode;e._sm[s].push({target:a,className:l})}}},m.parseRule=function(e,r){var s=e.name,t=this.rules[s]||y.rules[s];t&&(t instanceof Array?r.rules.push({rule:t[0],message:t[1]}):r.rules.push({rule:t,params:e.params}))},m.parseStringFunction=function(e){var r={name:e},s=e.indexOf("(");return s>0&&(r.name=e.substring(0,s),r.params=e.substring(s+1,e.length-1).split(",")),r},m.parseString=function(e){var r={rules:[]},s=e.indexOf("&")>-1?"&":"|",t=e.split(s);r.token=s;for(var n=t.length-1;n>=0;n--){var l=t[n];if(l)if(0===l.indexOf("/")){var a=l.substring(1).split("/");2===a.length?r.rules.push({rule:new RegExp(a[0]),message:a[1]}):3===a.length&&r.rules.push({rule:new RegExp(a[0],"i"),message:a[2]})}else{var i=this.parseStringFunction(l),u=i.name,f=!0;if("!"===u.charAt(0)&&(u=u.substring(1),f=!1),d.indexOf(u)>-1){var o=i.params;o?r[u]="failStyle"===u||"passStyle"===u?o[0]:o:r[u]=f}else this.parseRule(i,r)}}return r},m.parseField=function(e){if(e instanceof Array)return{rules:[{rule:e[0],message:e[1]}]};if(e instanceof Function)return{rules:[{rule:e}]};if(r(e))return this.parseString(e);if("object"==typeof e){if(e.token="|",e.rule instanceof Array)e.rules=[{rule:e.rule[0],message:e.rule[1]}];else if(e.rule instanceof Function)e.rules=[{rule:e.rule}];else if(r(e.rule)){var s=e.rule;delete e.rule,s.indexOf("&")>-1&&(e.token="&");var t=s.split(e.token);e.rules=[];for(var n=t.length-1;n>=0;n--)t[n]&&this.parseRule(this.parseStringFunction(t[n]),e)}return e}};var h,g,y={server:"not been validated by server",required:"this is required",rules:{}};return t.config=function(e){for(var r=d.length-1;r>=0;r--){var n=d[r];s(e,n)&&(y[n]=e[n])}if(e.rules)for(var l in e.rules)y.rules[l]=e.rules[l];h=new t},t.validate=function(e,s){var t=r(e)?h.queryInput(e):e,n=0,l=0,a=!1;s&&(g=s.locate,a=s.short);for(var i=t.length-1;i>=0;i--){var f=t[i];if(f._sm)if(l++,u(f,s)===!0)n++;else if(a)return!1}return l===n},t.reset=function(e){for(var s=r(e)?h.queryInput(e):e,t=s.length-1;t>=0;t--)i(s[t])},t});