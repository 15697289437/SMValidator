/*!
 * SMValidator.js 0.5.0
 * Copyright (c) 2016 WLDragon(cwloog@qq.com)
 */!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):e.SMValidator=r()}(this,function(){"use strict";function e(e,r){if(e){var t=this;r||(r={});for(var s=u.length-1;s>=0;s--){var l=u[s];t[l]=r[l]||o[l]}t.submit=r.submit,t.rules=r.rules||{},t.fields={};for(var n in r.fields)t.fields[n]=t.parseField(r.fields[n]);t.inputs=t.queryInput(e)}}function r(e,r,t){if(r){var s=e.className.split(" "),l=s.indexOf(r);!t&&l>-1?(s.splice(l,1),e.className=s.join(" ")):t&&l===-1&&(e.className+=e.className?" "+r:r)}}function t(e,r){e&&(e.style.display=r?"":"none")}function s(e,r){if(r)for(var t in r)e.style[t]=r[t]}function l(e){if("text"===e.type){var l=e._sm,n=l.rule,a=!0,i=1;if(n.required||""!==e.value)for(var u=n.rules.length-1;u>=0;u--){var f=n.rules[u],o=f.rule;if(o instanceof RegExp){if(!o.test(e.value)){a=f.message,i=2;break}}else if(a=f.params?o.apply(null,[e.value].concat(f.params)):o.call(null,e.value),a!==!0){i=2;break}}else i=0;return i!==l.flag&&(l.flag=i,s(e,l.style),t(l.failHtml,!1),t(l.passHtml,!1),0===i?(r(e,n.failCss,!1),r(e,n.passCss,!1)):1===i?(r(e,n.failCss,!1),r(e,n.passCss,!0),s(e,n.passStyle),t(l.passHtml,!0),n.pass&&n.pass.call(e)):(r(e,n.passCss,!1),r(e,n.failCss,!0),s(e,n.failStyle),t(l.failHtml,!0),l.failHtml&&(l.failHtml.innerText=a),n.fail&&n.fail.call(e))),a}}var n=window.document,a=n.addEventListener?n.addEventListener:n.attachEvent,i="oninput"in n?"input":"propertychange";a.call(n,i,function(e){var r=e.target;!r._sm||r._sm.rule.manul||r._sm.rule.blur||l(r)}),a.call(n,"change",function(e){var r=e.target;r._sm&&!r._sm.rule.manul&&r._sm.rule.blur&&l(r)});var u=["blur","manul","failHtml","failStyle","failCss","passHtml","passStyle","passCss"],f=e.prototype;f.queryInput=function(r,t){for(var s=this,l=[],i=n.querySelectorAll(r),u=i.length-1;u>=0;u--){var f=i[u];if("FORM"===f.tagName){f.novalidate="novalidate";for(var o=[],p=f.length-1;p>=0;p--)s.bindInput(f[p],t)&&o.push(f[p]);l=l.concat(o),s.submit&&o.length&&(f._SMInputs_=o,a.call(f,"submit",function(r){r.preventDefault();var t=e.validate(r.target._SMInputs_,!0);s.submit(t,r.target)}))}else"INPUT"===f.tagName&&s.bindInput(f,t)&&l.push(f)}return l},f.bindInput=function(e,r){function t(e,r){if("string"==typeof e[r])try{e[r]=JSON.parse(e[r].replace(/'/g,'"'))}catch(t){console.error("error json format: "+e[r])}}function s(e,r){if(r){e._sm.style||(e._sm.style={});var t=e._sm.style;for(var s in r)t[s]||(t[s]=e.style[s])}}function l(e,r,t){var s;if(0===t.indexOf("<")){var l=n.createElement("div");l.innerHTML=f.failHtml,s=l.childNodes[0],e.parentNode.insertBefore(s,e.nextElementSibling)}else s=n.querySelector(t);s&&(s.style.display="none",e._sm[r]=s)}if(e._sm&&!r)return!0;var a=e.getAttribute("name"),i=e.getAttribute("data-rule"),f=i?this.parseString(i):this.fields[a];if(f){if(e._sm={rule:f,flag:0},!f._isInit){f._isInit=!0;for(var o=u.length-1;o>=0;o--){var p=u[o];f[p]||(f[p]=this[p])}t(f,"failStyle"),t(f,"passStyle")}return s(e,f.failStyle),s(e,f.passStyle),f.failHtml&&l(e,"failHtml",f.failHtml),f.passHtml&&l(e,"passHtml",f.passHtml),!0}return!1},f.parseRule=function(e,r){var t=e.name,s=this.rules[t]||o.rules[t];s&&(s instanceof Array?r.rules.push({rule:s[0],message:s[1]}):r.rules.push({rule:s,params:e.params}),r.required="required"===t)},f.parseStringFunction=function(e){var r={name:e},t=e.indexOf("(");return t>0&&(r.name=e.substring(0,t),r.params=e.substring(t+1,e.length-1).split(",")),r},f.parseString=function(e){for(var r={rules:[]},t=e.split(";"),s=t.length-1;s>=0;s--){var l=t[s];if(""!==l)if(0===l.indexOf("/")){var n=l.substring(1).split("/");2===n.length?r.rules.push({rule:new RegExp(n[0]),message:n[1]}):3===n.length&&r.rules.push({rule:new RegExp(n[0],"i"),message:n[2]})}else{var a=this.parseStringFunction(l);if(u.indexOf(a.name)>-1){var i=a.name;"blur"===i||"manul"===i?r[i]=!0:r[i]=a.params[0]}else this.parseRule(a,r)}}return r},f.parseField=function(e){if(e instanceof Array)return{rules:[{rule:e[0],message:e[1]}]};if(e instanceof Function)return{rules:[{rule:e}]};if("string"==typeof e)return this.parseString(e);if("object"==typeof e){if(e.rule instanceof Array)e.rules=[{rule:e.rule[0],message:e.rule[1]}];else if(e.rule instanceof Function)e.rules=[{rule:e.rule}];else if("string"==typeof e.rule){var r=e.rule.split(";");e.rules=[];for(var t=r.length-1;t>=0;t--)""!==r[t]&&this.parseRule(this.parseStringFunction(r[t]),e);delete e.rule}return e}},f.validate=function(r,t){return e.validate(this.inputs,r,t)};var o={failHtml:'<span style="color:#c00;"></span>',failStyle:{color:"#c00",border:"1px solid #c00"},rules:{required:function(e){return""!==e||"这是必填项"},range:function(e,r,t){var s=e.length;return 2===arguments.length?r>=0?s>r||"长度必须大于"+r:s<-r||"长度必须小于"+-r:3===arguments.length?s>r&&s<t||"长度必须大于 "+r+" 且小于 "+t:void 0}}};e.config=function(e){for(var r=u.length-1;r>=0;r--){var t=u[r];e[t]&&(o[t]=e[t])}if(e.rules)for(var s in e.rules)o.rules[s]=e.rules[s]};var p=new e;return p.rules=p.fields={},e.validate=function(e,r,t){for(var s="string"==typeof e?p.queryInput(e,t):e,n=0,a=0,i=s.length-1;i>=0;i--){var u=s[i];u._sm&&(a++,(u._sm.rule.manul||r)&&l(u)===!0&&n++)}return a===n},e});